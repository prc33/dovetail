#!/bin/bash

FLAGS=-c1

test_cc() {
  make clean-benchmarks
  DOVETAIL_CALLCONV=$2 DOVETAIL_TAILCALLS=false make bin/fib bin/locks
  ./benchmark $FLAGS fib callconv-$1-notail 1 40 bin/fib 1 40
  ./benchmark $FLAGS fib callconv-$1-notail 2 40 bin/fib 2 40

  make clean-benchmarks
  DOVETAIL_CALLCONV=$2 DOVETAIL_TAILCALLS=true make bin/fib bin/locks
  ./benchmark $FLAGS fib callconv-$1-tail 1 40 bin/fib 1 40
  ./benchmark $FLAGS fib callconv-$1-tail 2 40 bin/fib 2 40
}

test_optlevel() {
  make clean-benchmarks
  DOVETAIL_OPTLEVEL=$2 make benchmarks
  ./benchmark $FLAGS fib $1 1 40 bin/fib 1 40
  ./benchmark $FLAGS fib $1 2 40 bin/fib 2 40
  ./benchmark $FLAGS locks $1 1 1 bin/locks 1 1
  ./benchmark $FLAGS locks $1 2 2 bin/locks 2 2
  ./benchmark $FLAGS nqueens $1 1 13 bin/nqueens 1 13
  ./benchmark $FLAGS nqueens $1 2 13 bin/nqueens 2 13
  ./benchmark $FLAGS quicksort $1 1 30000000 bin/quicksort 1 30000000
  ./benchmark $FLAGS quicksort $1 2 30000000 bin/quicksort 2 30000000
}

test_cc stdc      0
test_cc fastcc    8
#test_cc haskell  10 - Bad interaction with GC???
test_cc x86-std  64
test_cc x86-fast 65

test_optlevel none        0
test_optlevel functional  1
test_optlevel closed      2
test_optlevel bounds      3
test_optlevel all         4
